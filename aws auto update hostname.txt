#!/bin/bash
#set -x
#
#
#
export EC2_URL=https://ec2.us-west-1.amazonaws.com
export EC2_PRIVATE_KEY=/home/johnd/ec2-tools/pk-4LWJFYS6RW32U6MCMZKJWGNH5HI2LA3B.pem
export EC2_CERT=/home/johnd/ec2-tools/cert-4LWJFYS6RW32U6MCMZKJWGNH5HI2LA3B.pem

tzm_ec2s=/home/johnd/ec2-tools/tzm_ec2s
tzm_iName=/home/johnd/ec2-tools/tzm_iName
tzm_address=/home/johnd/ec2-tools/tzm_address

ec2-describe-instances --filter instance-state-name=running > $tzm_ec2s
cat $tzm_ec2s |grep Name |awk '{print $5}' |tr '.' '-' > $tzm_iName
cat $tzm_ec2s |grep INSTANCE |awk '{print $4}' > $tzm_address
n=1

cat $tzm_address|while read address
    do
        hostname_current=`ssh -i /home/johnd/support/johnd/johnd-aws.pem ubuntu@$address "hostname"`
        instance_name=`cat $tzm_iName|sed -n "$n p"`
            if [ "$hostname_current" != "$instance_name" ]
             then
                ssh -i /home/johnd/support/johnd/johnd-aws.pem ubuntu@$address \
                "sudo echo '127.0.0.1 $instance_name' | tee -a /etc/hosts; \
                sudo echo '$instance_name' > /etc/hostname; \
                sudo /etc/init.d/hostname restart"

                /usr/bin/sendEmail -f monitor@siq4you.com -t johnd@forthscale.com \
                -o message-charset=utf-8 -u "**Alert** $hostname_current Hostname Changed" \
                -m "Hostname changed name from $hostname_current to $instance_name"
              else
                echo "OK"
             fi
        n=`expr $n + 1`
     done
exit 0
